;
; Author: Guillem Alminyana
;
; Stack Technique for sys_execve to execute "/bin/ls -la".
; Example on how to deal with parameters with this technique
;
; Compile:
;	nasm -f elf64 file.nasm -o file.o
;	ld -N file.o -o file
; Test:
;	run ./file
;	connect from another terminal with nc localhost 4444
;

global _start 

section .text

_start:

	; Prepare argv[] parameters

	mov rcx, "-lau"              ; Stack <- -la
	push rcx 
	mov r8, rsp

	mov rcx, "/bin//ls"          ; Stack <- /bin/sh
	push rcx

	mov rbx, rsp                 ; RBX <- @ cadena:
			             ;	rbx = @/bin/ls
				     ;	rbx = @ -la

	; Push *filename parameter

	xor rax, rax		     ; Stack <- NULL
	push rax

	mov rcx, "/bin//ls"	     ; Stack <- String /bin//ls
	push rcx

	mov rdi, rsp		     ; RDI <- Apunta a parÃ¡metro filename

	; Push next parameters

	push rax   		     ; Stack <- NULL

	push r8			     ; Stack <- @ -la

	push rbx		     ; Stack <- @ /bin/ls

	mov rsi, rsp		     ; RSI <- @@ argv[]

	; Push last NULL
	;   Not pushing it but pointing to anu NULL in the Stack

	push rax
	mov rdx, rsp

	; Call the Execve syscall 
	add rax, 59
	syscall






